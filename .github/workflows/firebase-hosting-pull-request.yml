name: Deploy to Firebase Hosting on PR
on: pull_request
permissions:
  checks: write
  contents: read
  pull-requests: write

jobs:
  build_and_preview:
    if: ${{ github.event.pull_request.head.repo.full_name == github.repository }}
    runs-on: ubuntu-latest
    env:
      FIREBASE_CLI_EXPERIMENTS: webframeworks
      CI: true
      NO_COLOR: 1
      TERM: dumb
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      # >>> Opção 1: setar a política de limpeza ANTES do deploy preview <<<
      - name: Set Artifact Registry cleanup policy (us-east1/gcf-artifacts)
        run: |
          echo '${{ secrets.FIREBASE_SERVICE_ACCOUNT_BARBER_APP_FRONTEND }}' > ${HOME}/gcp.json
          export GOOGLE_APPLICATION_CREDENTIALS="${HOME}/gcp.json"

          npx firebase-tools@13.28.0 functions:artifacts:setpolicy \
            --location us-east1 \
            --repository gcf-artifacts \
            --retention 30d \
            --keep 5 \
            --delete-untagged \
            --non-interactive \
            --project barber-app-frontend

      - uses: FirebaseExtended/action-hosting-deploy@v1
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_BARBER_APP_FRONTEND }}
          projectId: barber-app-frontend
        env:
          FIREBASE_CLI_EXPERIMENTS: webframeworks
          CI: true
          NO_COLOR: 1
          TERM: dumb
